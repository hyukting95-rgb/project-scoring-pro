# 数据备份与恢复功能设置指南

## 概述
本系统已集成完整的数据备份与恢复功能，支持：
- 手动创建数据备份
- 自动定期备份（每周）
- 一键恢复备份数据
- 备份文件管理（删除、查看详情）
- 完整的用户数据隔离

## 设置步骤

### 1. 创建Supabase Storage Bucket

1. 登录Supabase控制台
2. 进入您的项目
3. 点击左侧菜单的"Storage"
4. 点击"Create a new bucket"
5. 设置bucket信息：
   - **Name**: `backups`
   - **Public**: 取消勾选（设为私有）
   - **File size limit**: 50MB（建议）
   - **Allowed MIME types**: `application/json`
6. 点击"Create bucket"

### 2. 执行数据库设置脚本

1. 在Supabase控制台中，点击左侧菜单的"SQL Editor"
2. 点击"New Query"
3. 复制并粘贴 `setup_backup_database.sql` 文件中的所有内容
4. 点击"Run"执行脚本

**注意**: 如果出现权限错误，请确保您是项目管理员。

### 3. 配置自动备份（可选）

系统默认启用自动备份功能，会在以下情况触发：
- 每周自动创建一次备份
- 保留最近4个自动备份
- 保留最近20个手动备份

如需禁用自动备份，可以在 `backup.ts` 文件中修改：
```typescript
const BACKUP_CONFIG = {
  auto_backup_enabled: false, // 改为false禁用
  // ... 其他配置
};
```

## 使用指南

### 访问备份功能

1. 在系统主界面，点击导航栏的"分数设置"标签
2. 切换到"数据备份"标签页

### 创建手动备份

1. 在备份管理界面，点击"创建备份"按钮
2. 输入备份名称和描述（可选）
3. 等待备份创建完成

### 恢复备份数据

⚠️ **重要警告**: 恢复备份会删除当前所有数据，请谨慎操作！

1. 在备份列表中找到要恢复的备份
2. 点击"恢复"按钮
3. 仔细阅读确认信息
4. 点击确认执行恢复
5. 系统会自动刷新页面以加载恢复的数据

### 管理备份文件

- **查看详情**: 备份列表显示创建时间、文件大小、数据统计等
- **删除备份**: 点击"删除"按钮可以删除不需要的备份
- **自动清理**: 系统会自动清理超出限制的旧备份

## 安全特性

### 数据隔离
- 每个用户只能查看和管理自己的备份
- 使用Supabase Row Level Security (RLS) 确保数据安全
- 备份文件存储在私有Storage bucket中

### 备份完整性
- 备份包含所有项目数据、人员记录和配置信息
- 支持数据完整性验证
- 提供详细的备份元数据

### 权限控制
- 只有登录用户可以创建和管理备份
- 用户只能操作自己创建的备份
- 恢复操作需要明确的用户确认

## 故障排除

### 常见问题

1. **备份创建失败**
   - 检查Supabase Storage bucket是否正确创建
   - 确认数据库设置脚本已执行
   - 检查网络连接是否正常

2. **恢复备份失败**
   - 确认备份文件存在于Storage中
   - 检查数据库权限设置
   - 确保有足够的存储空间

3. **自动备份未工作**
   - 检查 `auto_backup_enabled` 设置
   - 确认用户已登录系统
   - 检查浏览器控制台是否有错误信息

### 技术支持

如遇到技术问题，请：
1. 检查浏览器开发者工具的控制台错误信息
2. 确认Supabase项目的配置正确
3. 查看网络请求是否成功
4. 联系技术支持团队

## 备份策略建议

### 最佳实践

1. **定期手动备份**: 重要操作前创建手动备份
2. **命名规范**: 使用描述性的备份名称，如"重大更新前备份_2024-01-05"
3. **恢复测试**: 定期测试备份恢复功能
4. **存储监控**: 关注存储空间使用情况

### 备份保留策略

- **自动备份**: 保留4个最新的自动备份
- **手动备份**: 保留20个最新的手动备份
- **重要备份**: 手动备份不会自动删除，建议定期清理

## 数据安全承诺

- 所有备份数据加密存储
- 严格的用户权限控制
- 完整的操作日志记录
- 支持数据导出和迁移

---

**重要提醒**: 请定期测试备份恢复功能，确保在真正需要时能够成功恢复数据。建议每月进行一次恢复测试。