# 团队管理功能设置指南

本指南将帮助您设置和使用团队管理功能，实现多用户协作和权限管理。

## 目录
1. [系统要求](#系统要求)
2. [数据库设置](#数据库设置)
3. [角色权限说明](#角色权限说明)
4. [邀请团队成员](#邀请团队成员)
5. [管理团队成员](#管理团队成员)
6. [安全注意事项](#安全注意事项)
7. [故障排除](#故障排除)

## 系统要求

- ✅ 已完成Supabase项目设置
- ✅ 已完成基础数据库表创建
- ✅ 用户已登录系统

## 数据库设置

### 1. 创建团队管理表

在Supabase控制台中，进入SQL编辑器，执行以下语句：

```sql
-- 复制 setup_team_database.sql 中的所有内容到SQL编辑器
-- 然后点击"运行"按钮
```

### 2. 创建存储桶（如果需要）

在Supabase控制台中：
1. 进入Storage页面
2. 创建名为`team-avatars`的存储桶
3. 设置存储桶为公共读取

### 3. 初始化管理员账户

首次使用时，需要将当前用户设置为管理员：

```sql
-- 执行以下语句（只执行一次）
SELECT add_current_user_as_admin();
```

## 角色权限说明

### 管理员 (Admin)
- ✅ 可以邀请新成员
- ✅ 可以邀请管理员
- ✅ 可以修改成员角色
- ✅ 可以暂停/激活成员
- ✅ 可以移除成员
- ✅ 可以查看所有团队数据
- ✅ 可以管理所有项目

### 普通成员 (Member)
- ✅ 可以接受邀请加入团队
- ✅ 可以录入和管理自己的项目
- ✅ 可以查看团队数据
- ❌ 不能邀请其他成员
- ❌ 不能修改其他成员信息
- ❌ 不能删除团队数据

## 邀请团队成员

### 方法1：通过系统界面

1. **登录系统**并进入"分数设置"页面
2. **点击"团队管理"标签页**
3. **点击"邀请成员"按钮**
4. **输入邮箱地址**和选择角色
5. **点击"发送邀请"**
6. **复制邀请链接**并发送给目标用户

### 方法2：通过邀请链接

邀请链接格式：
```
https://your-app-url.com?invite_token=ABC123...
```

## 管理团队成员

### 查看成员信息

在"团队管理"标签页中，您可以查看：
- 总成员数、活跃成员数、管理员数
- 成员列表（姓名、邮箱、角色、状态）
- 加入时间和最后活动时间

### 修改成员角色

1. 在成员列表中找到目标成员
2. 点击"升为管理员"或"降为成员"按钮
3. 确认操作

### 暂停/激活成员

1. 在成员列表中找到目标成员
2. 点击"暂停"或"激活"按钮
3. 确认操作

### 移除成员

⚠️ **警告：此操作不可撤销！**

1. 在成员列表中找到目标成员
2. 点击"移除"按钮
3. 仔细阅读警告信息
4. 确认操作

## 邀请链接使用流程

### 对于被邀请的用户

1. **收到邀请链接**
2. **点击链接**进入系统
3. **注册或登录**账户（邮箱必须与邀请邮箱一致）
4. **系统自动处理**邀请
5. **成功加入**团队

### 邀请状态说明

- **待处理**：邀请已发送，等待用户接受
- **已使用**：用户已接受邀请
- **已过期**：邀请链接超过72小时未使用
- **已取消**：管理员取消了邀请

## 安全注意事项

### 1. 管理员数量限制
- 最多2个管理员
- 只有管理员可以邀请管理员

### 2. 邀请链接安全
- 邀请链接72小时内有效
- 链接只能使用一次
- 邮箱必须与邀请邮箱匹配

### 3. 数据权限
- 用户只能查看自己的邀请
- 只有管理员可以管理团队成员
- 所有数据访问都通过RLS保护

### 4. 操作记录
- 所有团队操作都有日志记录
- 成员活动时间会自动更新
- 邀请状态实时同步

## 故障排除

### 常见问题

**1. 无法邀请管理员**
```
错误：只有管理员可以邀请其他管理员
解决：联系现有管理员进行邀请
```

**2. 邀请链接无法使用**
```
可能原因：
- 链接已过期（超过72小时）
- 邮箱不匹配
- 已经被使用过
解决：重新发送邀请
```

**3. 用户无法接受邀请**
```
检查项目：
- 用户是否已注册/登录
- 邮箱是否与邀请邮箱一致
- 邀请状态是否为"待处理"
```

**4. 团队统计数据不准确**
```sql
-- 手动刷新统计数据
SELECT 
  get_team_stats();
```

### 数据库清理

定期清理过期邀请：

```sql
-- 清理过期邀请
SELECT cleanup_expired_invitations();
```

### 检查用户权限

```sql
-- 检查当前用户是否为管理员
SELECT is_team_admin();

-- 检查当前用户是否为团队成员
SELECT is_team_member();

-- 获取当前用户角色
SELECT get_current_user_role();
```

## 最佳实践

### 1. 团队管理
- 定期检查团队成员列表
- 及时清理不需要的邀请
- 合理分配管理员权限

### 2. 安全建议
- 不要分享管理员邀请链接
- 定期检查团队活动日志
- 及时暂停离职成员账户

### 3. 性能优化
- 定期清理过期数据
- 监控数据库连接数
- 优化查询索引

---

## 联系支持

如果遇到问题，请提供以下信息：
1. 错误消息截图
2. 操作步骤描述
3. 用户邮箱和角色
4. 浏览器控制台错误（如有）

**系统版本**：v2.0.0+  
**最后更新**：2026-01-05